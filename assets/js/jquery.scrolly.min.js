(function ($) {
    function calculateOffset(selector, options) {
        var element, offset, adjustedOffset;

        if ((element = $(selector))[length] === 0) {
            return null;
        }

        offset = element[offset]()[top];

        switch (options.anchor) {
            case "middle":
                adjustedOffset =
                    offset - ($(window).height() - element.outerHeight()) / 2;
                break;
            default:
            case top:
                adjustedOffset = Math.max(offset, 0);
        }

        return typeof options[offset] === "function"
            ? (adjustedOffset -= options[offset]())
            : (adjustedOffset -= options[offset]), adjustedOffset;
    }

    var length = "length",
        nullValue = null,
        top = "top",
        offset = "offset",
        clickEvent = "click.scrolly",
        windowElement = $(window);

    $.fn.scrolly = function (options) {
        var element,
            href,
            offsetValue,
            settings,
            result = $(this);

        if (this[length] === 0) {
            return result;
        }

        if (this[length] > 1) {
            for (element = 0; element < this[length]; element++) {
                $(this[element]).scrolly(options);
            }
            return result;
        }

        offsetValue = nullValue;
        settings = $.extend(
            {
                anchor: top,
                easing: "swing",
                offset: 0,
                parent: $("body,html"),
                pollOnce: false,
                speed: 1000,
            },
            options
        );

        if (settings.pollOnce) {
            offsetValue = calculateOffset(this.attr("href"), settings);
        }

        result
            .off(clickEvent)
            .on(clickEvent, function (event) {
                var adjustedOffset =
                    offsetValue !== nullValue
                        ? offsetValue
                        : calculateOffset($(this).attr("href"), settings);

                if (adjustedOffset !== nullValue) {
                    event.preventDefault();
                    settings.parent
                        .stop()
                        .animate({ scrollTop: adjustedOffset }, settings.speed, settings.easing);
                }
            });

        return result;
    };
})(jQuery);
